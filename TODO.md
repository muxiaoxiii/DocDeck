# DocDeck 开发任务清单

## 当前状态 (2025-08-20)

### ✅ 已完成任务

#### 架构重构
- [x] 1.1 彻底解耦UI与业务逻辑
- [x] 1.2 完善错误处理与日志机制
- [x] 1.3 模块化UI组件分离
- [x] 1.4 事件处理器统一管理
- [x] 1.5 国际化模块重构
- [x] 1.6 完成工具函数模块
- [x] 1.7 完善国际化抽取
- [x] 1.8 代码清理和优化
- [x] 1.9 主窗口进一步精简

#### UI优化
- [x] 2.1 输出文件夹布局优化
- [x] 2.2 状态显示位置调整
- [x] 2.3 文件列表功能完善（右键菜单改造：编辑/删除原页眉页脚）
- [x] 2.4 导入标注（检测结构化页眉/页脚加标记）
- [x] 2.5 设置面板布局重构和美化
- [x] 2.6 控件样式统一和交互效果优化
- [x] 2.7 移除冗余控件（内存优化、旧按钮等）

#### 功能修复/增强
- [x] 3.1 预览混合渲染：PyMuPDF底图 + ReportLab文本层（中文一致性）
- [x] 3.2 结构化写入：/Artifact Header/Footer + DocDeck元数据（DDTemplate/DateFmt/Align/Unit/Version/Type）
- [x] 3.3 占位符：{page} {total} {filename} {basename} {date:%Y-%m-%d}
- [x] 3.4 页眉页脚检测算法优化（解决空白页问题）
- [x] 3.5 安全删除机制（备份、验证、回滚）
- [x] 3.6 预设位置按钮功能完善

### ⚠️ 当前问题（更新）
- [ ] 预览叠加策略：当存在原有Artifact时的"保留/替换/删除"模式切换与显示策略
- [ ] Artifact 删除粒度：仅删除DDVersion对应对象或按Header/Footer范围细化
- [ ] 图标列：以专用列显示"锁/结构化"图标，避免污染文件名

## 🎯 短期任务 (1-2周)

### 高优先级
- [ ] 1. 编辑对话框（独立模块）
  - 展示：Artifact解析结果、启发式候选、模板字符串、对齐、日期格式、位置
  - 预览：所见即所得，支持"只看新/叠加对比/只看原有"
  - 写回：替换模式下先删同类Artifact再写入；支持仅Header/仅Footer
- [ ] 2. 文件列表图标列
  - 新增一列：显示"锁"与"结构化标记"图标
  - 移除名称★标记，保持名称纯净
- [ ] 3. 删除逻辑细化
  - 仅删除包含 `/DDVersion` 的对象（DocDeck写入）
  - 提供"仅Header/仅Footer"选项
- [ ] 4. 读取合并策略
  - Artifact优先；缺失时启发式候选
  - 若存在 `DDTemplate` 则优先回填模板
- [ ] 5. 预览模式切换（逐文件）
  - 保留（默认）/替换/删除 三态
  - 叠加对比（可选、半透明显示原有）

### 重复模块与重构任务
- [ ] 清理重复与备份代码：
  - 删除：`ui_main_backup.py`、`ui_main_backup2.py`、`ui_main_backup3.py`、`ui_main_preview_backup.py`、`ui_main.py.backup*`
  - 删除：多余 Markdown 文档（已合并进 README/TODO）
- [x] 业务检测统一改造：
  - 所有调用点改为直接使用 `pdf_analyzer.PdfAnalyzer`（controller 与编辑对话框已完成）
  - 移除 `pdf_utils` 兼容层文件
- [x] 删除功能模块重复：
  - 移除 `pdf_utils`（检测已迁移至 `pdf_analyzer`；字体注册迁至 `font_manager`）
  - `controller` 中删除逻辑已由 `pdf_handler.remove_headers_footers` 执行，确保不直接改写内容流

### 中优先级
- [ ] 6. Type0/ToUnicode 子集化优化
  - 更小的字体子集与稳定的CMap生成
- [ ] 7. 结构化读取API
  - 暴露读取与写入API，支持脚本化落地

### 重构任务
- [x] 8. 完成工具函数模块
  - natural_sort.py / ui_helpers.py 单元测试
- [x] 9. 主窗口进一步精简
  - 抽取"编辑对话框"到 `ui/components/dialogs/editor.py`

## 📊 进度跟踪

### 当前进度
- **总体完成度**: 65%
- **架构重构**: 95%
- **核心功能**: 85%
- **UI优化**: 90%
- **预览/结构化**: 80%

### 里程碑
- [x] 里程碑1: 基础架构重构完成 (2025-08-19)
- [x] 里程碑2: UI布局优化和页眉页脚检测算法修复 (2025-08-20)
- [ ] 里程碑3: 结构化读/写/预览闭环 (目标: 2025-09-05)
- [ ] 里程碑4: 编辑对话框与图标列 (目标: 2025-09-10)

## 🆕 最近完成的重要工作

### 页眉页脚检测算法修复 (2025-08-19 至 2025-08-20)

#### 第一天 (2025-08-19)
- ✅ 诊断并分析了PDF处理后变成空白页的问题
- ✅ 设计了Artifact检测和启发式检测的优化方案
- ✅ 设计了包含备份、验证、回滚的安全删除机制

#### 第二天 (2025-08-20)
- ✅ 实施了检测算法的优化和安全删除机制
- ✅ 测试验证了修复效果，确保功能正常工作
- ✅ 提高了检测的准确性和可靠性

### UI布局优化 (2025-08-20)
- ✅ 重新设计了设置面板的布局结构
- ✅ 统一了所有控件的样式和交互效果
- ✅ 优化了控件间距、添加了悬停效果和焦点状态
- ✅ 移除了冗余控件，保持了功能的完整性

---

*最后更新：2025-08-20*
*文档维护者：开发团队*
